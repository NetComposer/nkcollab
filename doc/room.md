# ROOM Application

This plugin allows you to manage SFU rooms easily.

This documente describes the currently supported External API commands for core NkCOLLAB. 
See the [NkSERVICE API Introduction](https://github.com/NetComposer/nkservice/blob/luerl/doc/api_intro.md) for an introduction to the interface, along with [NkMEDIA](https://github.com/NetComposer/nkcollab) documentation.

Once the room is created, you can create new _members_, that can be either:
* _presenter_: a member that publishes one stream and can listen (offered by presenters)
* _viewer_: a member that publishes no stream but can listen to one or any number of streams (offered by presenters).

* [**Commands**](#commands)
  * [`create`](#create): Create a new room
  * [`destroy`](#destroy): Destroys a room
  * [`get_list`](#get_list): List known rooms
  * [`get_info`](#get_info): Gets information about a room
  * [`create_presenter`](#create_presenter): Starts a new _presenter_
  * [`get_presenters`](#get_presenters): Gets a list of all current _presenters_
  * [`create_viewer`](#create_viewer): Starts a new _viewer_
  * [`set_answer`](#set_answer): Sets the answer for a session
  * [`get_viewers`](#get_viewers): Gets a list of all current _viewers_
  * [`destroy_member`](#destroy_member): Destroys a previously started _presenter_ or  _viewer_
  * [`update_presenter`](#update_presenter): Chnages current _presenter_ media and reconnect all current connecte to it to the new publish stream.
  * [`add_listener`](#add_listener): Adds a new _listening_ stream to a _publisher_ or _viewer_.
  * [`remove_listener`](#remove_listener): Removes a _listening_ stream to a _publisher_ or _viewer_.
  * [`update_meta`](#update_meta): Updates a current member _metadata_.
  * [`update_media`](#update_media): Updates media parameters like muting and bandwidth.
  * [`send_broadcast`](#send_broadcast): Sends a broadcast, persistent message to all participants.
  * [`get_all_broadcasts`](#get_all_broadcasts): Retrieves all broadcasts sent for this room.
  * [`set_candidate`](#set_candidate): Sends a Trickle ICE candidate
  * [`set_candidate_end`](#set_candidate_end): Signals that no more candidates are available
* [**Events**](#events)

All commands must have 

```js
{
  class: "collab",
  subclass: "room"
}
```


# Commands

## create

Allows you to create a new room. You can supply a name or allow NkMEDIA to generate a random new one. 


The supported options are:

Field|Default|Description
---|---|---|---
room_id|(automatic)|Room Id (will be autogenerated if not included)
backend|(automatic)|Forces a specific backend for the room (see bellow)
audio_codec|"opus"|Supported by Janus
video_codec|"vp8"|Supported by Janus
bitrate|0|Supported by Janus
meta|any|Metadata for the room

**Sample**

 ```js
{
	class: "collab",
  	subclass: "room",
  	cmd: "create",
  	data: {
    	video_codec: "vp9"
  },
  tid: 1
}
```
-->
 ```js
{
	result: "ok",
	data: {
    	room_id: "4611e276-3919-9683-0bae-38c9862f00d9"
    },
    tid: 1
}
```

The following NkMEDIA backends can be used to create rooms:
* [Janus](https://github.com/NetComposer/nkmedia/doc/janus.md) (default)
* [Kurento](https://github.com/NetComposer/nkmedia/doc/kms.md) (default)



## destroy

Destroys a started room. Current members, if any, will be removed. The `room_id` is mandatory.


**Sample**

 ```js
{
	class: "collab",
  	subclass: "room",
  	cmd: "destroy",
  	data: {
    	room_id: "4611e276-3919-9683-0bae-38c9862f00d9"
  	},
  	tid: 1
}
```


## get_list

Gets a list of known rooms, along with its metadata

**Sample**

 ```js
{
	class: "collab",
  	subclass: "room",
  	cmd: "get_list",
    tid: 1
}
```
-->
 ```js
{
	result: "ok",
	data: [
	    {
	      room_id: "002f5758-3919-9408-4a02-38c9862f00d9",
        meta: {field1: "val1"}
	    },
	    {
	      room_id: "8a87bfc2-3919-9161-b1ab-38c9862f00d9",
        meta: {}
	    }
  	],
    tid: 1
}
```


## get_info

Gets information about a started room


**Sample**

 ```js
{
	class: "collab",
  	subclass: "room",
  	cmd: "get_info",
  	data: {
  		room_id: "002f5758-3919-9408-4a02-38c9862f00d9"
  	},
    tid: 1
}
```
-->
 ```js
{
	result: "ok",
	data: {
		backend: "nkmedia_janus",
        audio_codec: "pcma"
    },
    tid: 1
}
```


## create_presenter

Starts a new member with _presenter_ role into the room. The fields `room_id` and `offer`for the publishing stream are mandatory:

Field|Default|Description
---|---|---|---
room_id|(mandatory)|Room Id
offer|(mandatory)|SDP Offer
meta|any|Metadata for the this member
no_answer_trickle_ice|false|Insert candidates in SDP response
trickle_ice_timeout|-|Time for ICE timeout
mute_audio|false|Mute presenter's audio
mute_video|Mute presenter's video
bitrate|100000|Set bitrate (kpbs)


events_body|-|Body to include in events

NkCOLLAB will reply with the `answer` and the `member_id`. You can the use it to create new listeners, or destroy the member and all its sessions. You will get also NkMEDIA's `session_id`.

The connection is automatically subscribed to all events related to this room. 


**Sample**

 ```js
{
    class: "collab",
    subclass: "room",
    cmd: "create_publisher",
    data: {
        room_id: "002f5758-3919-9408-4a02-38c9862f00d9",
        offer: {
            sdp: ...
        },
        meta: {
            device: "mobile"
        }
    },
    tid: 1
}
```
-->
 ```js
{
    result: "ok",
    data: {
        member_id: 1,
        answer: {
            sdp: ...
        },
        session_id: "7ae2dda9-3f9e-ac43-7152-001b78e02fb6"
    },
    tid: 1
}
```


## get_presenters

Gets a lists of all current presenters for the room


**Sample**

 ```js
{
    class: "collab",
    subclass: "room",
    cmd: "get_presenters",
    data: {
        room_id: "002f5758-3919-9408-4a02-38c9862f00d9"
    },
    tid: 1
}
```
-->
 ```js
{
    result: "ok",
    data: [
        {
            member_id: 1,
            user_id: "user1",
            meta: {
                ...
            }
        }
    ],
    tid: 1
}
```



## create_viewer

Starts a new member with _viewer_ role into the room. Felds `room_id` and `presenter_id` (_member_id_ of the presenter you want to listen to) are mandatory. NkCOLLAB will reply with the `offer` and the `member_id`, and the member must call [set_answer](#set_answer) to send the answer back, using the supplied `session_id`.


Field|Default|Description
---|---|---|---
room_id|(mandatory)|Room Id
presenter_id|(mandatory)|Presenter to listen to
meta|any|Metadata for the this member
no_offer_trickle_ice|false|Insert candidates in SDP offer
trickle_ice_timeout|-|Time for ICE timeout
events_body|-|Body to include in events

The connection is automatically subscribed to all events related to this room.


**Sample**

 ```js
{
    class: "collab",
    subclass: "room",
    cmd: "create_viewer",
    data: {
        room_id: "002f5758-3919-9408-4a02-38c9862f00d9",
        meta: {
            device: "mobile"
        }
    },
    tid: 1
}
```
-->
 ```js
{
    result: "ok",
    data: {
        member_id: 1,
        offer: {
            sdp: ...
        },
        session_id: "2a60f564-3f9e-ac44-617f-001b78e02fb6"
    },
    tid: 1
}
```


## set_answer

When the started session's type requires you to supply an _answer_ (because the backend already generated the _offer_), you must use this API to set the session's _answer_. 

Field|Default|Description
---|---|---
session_id|(mandatory)|Session Id
answer|(mandatory)|Answer for the session


**Sample**

```js
{
    class: "collab",
    subclass: "room",
    cmd: "set_answer",
    session_id: "2a60f564-3f9e-ac44-617f-001b78e02fb6",
    data: {
        answer: {
            "sdp": "..."
        }
    }
    tid: 1
}
```
-->
```js
{
    result: "ok",
    tid: 1
}
```


## get_viewers

Gets a lists of all current viewers for the room


**Sample**

 ```js
{
    class: "collab",
    subclass: "room",
    cmd: "get_viewers",
    data: {
        room_id: "002f5758-3919-9408-4a02-38c9862f00d9"
    },
    tid: 1
}
```
-->
 ```js
{
    result: "ok",
    data: [
        {
            member_id: 2,
            user_id: "user2",
            presenter_id: 1
            meta: {
                ...
            }
        }
    ],
    tid: 1
}
```


## set_candidate

When the client sends an SDP _offer_ or _answer_ without candidates (and with the field `trickle_ice=true`), it must use this command to send candidates to the backend. The following fields are mandatory:

Field|Sample|Description
---|---|---
session_id|-|Session id this candidate refers to
sdpMid|"audio"|Media id
sdpMLineIndex|0|Line index
candidate|"candidate..."|Current candidate


## set_candidate_end

When the client has no more candidates to send, it should use this command to inform the server.



## destroy_member

Removes a member and destroys all related media sessions (publishers and listeners).

Fields `member_id` and `room_id` are mandatory.


## update_presenter

Updates a current presenter with a new SDP. Fields `room_id`, `member_id` and `offer` are mandatory.


## add_listener

Adds a new _listener_ session to a current _presenter_ or _viewer_ member.

Fields `room_id`, `member_id` and `presenter_id` are mandatory. NkCOLLAB will reply with the `offer` and the `session_id`, and the member must call [set_answer](#set_answer) once it has the answer available.


## remove_listener

Stops a started listening session. Fields `room_id`, `member_id` and `presenter_id` are mandatory.

If this is the last session of a _viewer_ member, it will be destroyed.


## update_meta

Updates _metadata_ for a current member, and send an event to all participants.
Fields `room_id`, `member_id` and `meta` are mandatory.


## update_media

Allows you to update some media characteristics of a publishing (created by a _presenter_) media:

Field|Default|Description
---|---|---|---
room_id|(mandatory)|Room Id
member_id|(mandatory)|Room Id
mute_audio|false|Mute presenter's audio
mute_video|Mute presenter's video
bitrate|100000|Set bitrate (kpbs)


## send_broadcast

Sends a broadcast message to all participants in the room. The message will also stored during all the room's life, and can be retrieved later using [get_all_broadcasts](#get_all_broadcasts).

**Sample**

```js
{
    class: "collab",
    subclass: "room",
    cmd: "send_broadcast",
    data: {
        room_id: "2a60f564-3f9e-ac44-617f-001b78e02fb6",
        member_id: 1,
        msg: {
            ...
        }
    },
    tid: 1
}
```

## get_all_broadcasts

Retrieves all previously sent broadcast messages





# Events

You can subscribe to receive room events, as described in the NkService documentation. By default, sessions calling `create_publisher` or `create_viewer` will be automaically subscribed to all event types for its room.


All room generated events will follow the pattern:

```js
{
  class: "core",
  cmd: "event",
  data: {
    class: "collab",
    subclass: "room",
    type: "...",
    obj_id: "...",        
    body: {
      ...
    }
  },
  tid: 1
}
```

The `obj_id` field will match the _room id_, and the following types are supported: 


Type|Relevant fields in body|Description
---|---|---
created|backend, meta|Fired when a new room is created
destroyed|code, reason|A room has been destroyed
started_member|member_id, role, user_id, meta|Fired when a new members joins the room
stopped_member|member_id, role, user_id, meta|An existing member is leaving the room
stopped_session|member_id, session_id|A session (belonging to a member) has stopped
broadcast|member_id, user_id, ...|Broadcast message
updated_meta|member_id, meta|A member has updated it's _metadata_
updated_media|member_id, ...|A member has updated it's media
member_info|member_id, ...|Several possible informations about user
room_info|member_id, ...|Several possible informations about the room

